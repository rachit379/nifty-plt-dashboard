<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nifty PLT Dashboard – Candlesticks & Technicals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1020;
      color: #f5f5f5;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand-title {
      font-size: 20px;
      font-weight: 600;
    }
    .brand-subtitle {
      font-size: 13px;
      opacity: 0.8;
    }
    main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .panel {
      background: #151a30;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }
    .panel-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .chart-container {
      position: relative;
      height: 320px;
    }
    .chart-container-small {
      position: relative;
      height: 180px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1.3fr 0.7fr;
      }
    }
  </style>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <header>
    <div>
      <div class="brand-title">Nifty PLT Dashboard</div>
      <div class="brand-subtitle">Nifty 50 Candlesticks · Bollinger Bands · RSI · Awesome Oscillator</div>
    </div>
    <div id="lastUpdated" style="font-size: 12px; opacity: 0.8;">Loading…</div>
  </header>

  <main>
    <section class="panel">
      <div class="panel-title">Nifty 50 – Price & Technicals</div>
      <div class="charts-grid">
        <div>
          <div class="chart-container" id="nifty-candles"></div>
        </div>
        <div>
          <div class="chart-container-small" id="nifty-rsi"></div>
          <div class="chart-container-small" id="nifty-ao"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const charts = [];

    async function loadData() {
      const res = await fetch("data/nifty_technicals.json");
      if (!res.ok) {
        console.error("Failed to load data/nifty_technicals.json");
        return [];
      }
      const data = await res.json();
      return data;
    }

    function createMainChart(data) {
      const container = document.getElementById("nifty-candles");
      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: {
          background: { color: "#151a30" },
          textColor: "#d6e4ff",
        },
        grid: {
          vertLines: { color: "rgba(200, 200, 255, 0.05)" },
          horzLines: { color: "rgba(200, 200, 255, 0.05)" },
        },
        rightPriceScale: {
          borderVisible: false,
        },
        timeScale: {
          borderVisible: false,
          timeVisible: true,
          secondsVisible: false,
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor: "#26a69a",
        downColor: "#ef5350",
        borderDownColor: "#ef5350",
        borderUpColor: "#26a69a",
        wickDownColor: "#ef5350",
        wickUpColor: "#26a69a",
      });

      const bbMidSeries = chart.addLineSeries({
        color: "rgba(255, 255, 255, 0.7)",
        lineWidth: 1,
      });
      const bbUpperSeries = chart.addLineSeries({
        color: "rgba(129, 212, 250, 0.8)",
        lineWidth: 1,
      });
      const bbLowerSeries = chart.addLineSeries({
        color: "rgba(129, 212, 250, 0.8)",
        lineWidth: 1,
      });

      const candleData = data.map(d => ({
        time: d.time,
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close,
      }));

      const bbMidData = data.map(d => ({
        time: d.time,
        value: d.bb_mid,
      }));
      const bbUpperData = data.map(d => ({
        time: d.time,
        value: d.bb_upper,
      }));
      const bbLowerData = data.map(d => ({
        time: d.time,
        value: d.bb_lower,
      }));

      candleSeries.setData(candleData);
      bbMidSeries.setData(bbMidData);
      bbUpperSeries.setData(bbUpperData);
      bbLowerSeries.setData(bbLowerData);

      charts.push(chart);
      return chart;
    }

    function createRsiChart(data) {
      const container = document.getElementById("nifty-rsi");
      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: {
          background: { color: "#151a30" },
          textColor: "#d6e4ff",
        },
        grid: {
          vertLines: { color: "rgba(200, 200, 255, 0.05)" },
          horzLines: { color: "rgba(200, 200, 255, 0.05)" },
        },
        rightPriceScale: {
          borderVisible: false,
        },
        timeScale: {
          borderVisible: false,
          timeVisible: true,
          secondsVisible: false,
        },
      });

      const rsiSeries = chart.addHistogramSeries({
        priceFormat: { type: "price", precision: 2, minMove: 0.1 },
      });

      const rsiData = data.map(d => {
        let color = "rgba(144, 202, 249, 0.7)"; // neutral
        if (d.rsi >= 70) color = "rgba(239, 83, 80, 0.85)";      // overbought
        else if (d.rsi <= 30) color = "rgba(102, 187, 106, 0.85)"; // oversold
        return {
          time: d.time,
          value: d.rsi,
          color,
        };
      });

      rsiSeries.setData(rsiData);

      // Reference lines at 30 and 70
      rsiSeries.createPriceLine({
        price: 30,
        color: "rgba(102, 187, 106, 0.7)",
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        axisLabelVisible: true,
        title: "30",
      });
      rsiSeries.createPriceLine({
        price: 70,
        color: "rgba(239, 83, 80, 0.7)",
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        axisLabelVisible: true,
        title: "70",
      });

      charts.push(chart);
      return chart;
    }

    function createAoChart(data) {
      const container = document.getElementById("nifty-ao");
      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: {
          background: { color: "#151a30" },
          textColor: "#d6e4ff",
        },
        grid: {
          vertLines: { color: "rgba(200, 200, 255, 0.05)" },
          horzLines: { color: "rgba(200, 200, 255, 0.05)" },
        },
        rightPriceScale: {
          borderVisible: false,
        },
        timeScale: {
          borderVisible: false,
          timeVisible: true,
          secondsVisible: false,
        },
      });

      const aoSeries = chart.addHistogramSeries({
        priceFormat: { type: "price", precision: 4, minMove: 0.0001 },
      });

      const aoData = data.map(d => ({
        time: d.time,
        value: d.ao,
        color: d.ao >= 0 ? "rgba(102, 187, 106, 0.8)" : "rgba(239, 83, 80, 0.8)",
      }));

      aoSeries.setData(aoData);

      aoSeries.createPriceLine({
        price: 0,
        color: "rgba(255, 255, 255, 0.5)",
        lineWidth: 1,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        axisLabelVisible: true,
        title: "0",
      });

      charts.push(chart);
      return chart;
    }

    function syncTimeScales(mainChart, otherCharts) {
      const mainTimeScale = mainChart.timeScale();

      mainTimeScale.subscribeVisibleLogicalRangeChange(range => {
        if (!range) return;
        otherCharts.forEach(ch => {
          const ts = ch.timeScale();
          ts.setVisibleLogicalRange(range);
        });
      });
    }

    function updateLastUpdated(data) {
      if (!data || !data.length) return;
      const last = data[data.length - 1];
      const dt = new Date(last.time * 1000);
      const formatted =
        dt.getFullYear() +
        "-" +
        String(dt.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(dt.getDate()).padStart(2, "0") +
        " " +
        String(dt.getHours()).padStart(2, "0") +
        ":" +
        String(dt.getMinutes()).padStart(2, "0");
      const el = document.getElementById("lastUpdated");
      if (el) {
        el.textContent = "Last data point: " + formatted + " (delayed)";
      }
    }

    function resizeAllCharts() {
      const mainContainer = document.getElementById("nifty-candles");
      const rsiContainer = document.getElementById("nifty-rsi");
      const aoContainer = document.getElementById("nifty-ao");

      const sizes = [
        { chart: charts[0], container: mainContainer },
        { chart: charts[1], container: rsiContainer },
        { chart: charts[2], container: aoContainer },
      ];

      sizes.forEach(item => {
        if (!item.chart || !item.container) return;
        item.chart.applyOptions({
          width: item.container.clientWidth,
          height: item.container.clientHeight,
        });
      });
    }

    window.addEventListener("load", async () => {
      const data = await loadData();
      if (!data.length) return;

      const mainChart = createMainChart(data);
      const rsiChart = createRsiChart(data);
      const aoChart = createAoChart(data);

      syncTimeScales(mainChart, [rsiChart, aoChart]);
      updateLastUpdated(data);

      window.addEventListener("resize", resizeAllCharts);
      resizeAllCharts();
    });
  </script>
</body>
</html>
